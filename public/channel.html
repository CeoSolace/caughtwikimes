<!DOCTYPE html>
<html lang="en" class="h-full bg-[#36393F]">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CaughtWiki</title>
  <link rel="manifest" href="/manifest.json"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body { font-family: 'Inter', sans-serif; }
    .scroller { scrollbar-width: none; }
    .scroller::-webkit-scrollbar { display: none; }
    .sidebar { background-color: #202225; }
    .channel-list { background-color: #2F3136; }
    .chat-area { background-color: #36393F; }
    .message-input { background-color: #40444B; }
    .user-panel { background-color: #292B2F; }
    .message-bubble { max-width: 80%; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #36393F; margin: 5% auto; padding: 20px; border-radius: 8px; width: 600px; max-width: 90%; max-height: 80vh; overflow-y: auto; }
    .close { float: right; font-size: 24px; font-weight: bold; cursor: pointer; color: #7289DA; }
    .action-icon { 
      display: inline-block; width: 20px; height: 20px; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; font-weight: bold; margin-right: 8px;
    }
    .action-join { background-color: #43B581; color: white; }
    .action-leave { background-color: #F04747; color: white; }
    .action-create { background-color: #5865F2; color: white; }
    .action-ban { background-color: #F04747; color: white; }
    .action-kick { background-color: #FAA61A; color: white; }
    .action-timeout { background-color: #F04747; color: white; }
  </style>
</head>
<body class="h-screen flex">
  <!-- Server Sidebar -->
  <div class="w-18 bg-[#18191C] flex flex-col items-center py-3 space-y-2">
    <div class="w-12 h-12 bg-[#5865F2] rounded-full flex items-center justify-center text-white font-bold cursor-pointer hover:bg-[#4752c4] transition-colors">
      C
    </div>
    <div class="w-8 h-0.5 bg-gray-500 rounded-full"></div>
    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white font-bold cursor-pointer hover:bg-green-600 transition-colors">
      +
    </div>
  </div>

  <!-- Server Channels -->
  <div class="w-60 sidebar flex flex-col">
    <div id="serverName" class="h-12 flex items-center px-4 text-white font-semibold border-b border-[#202225]">
      Loading...
    </div>
    
    <div id="channelList" class="flex-1 overflow-y-auto scroller px-2 py-2">
      <div class="text-gray-400 text-xs px-2 mb-1">TEXT CHANNELS</div>
      <div class="channel-item text-white px-2 py-1 rounded cursor-pointer hover:bg-[#37393F] flex items-center mb-1" data-channel="general">
        <i class="fas fa-hashtag mr-1"></i>
        general
      </div>
      <div class="channel-item text-white px-2 py-1 rounded cursor-pointer hover:bg-[#37393F] flex items-center mb-1" data-channel="rules">
        <i class="fas fa-hashtag mr-1"></i>
        rules
      </div>
      
      <div class="text-gray-400 text-xs px-2 mb-1 mt-4">VOICE CHANNELS</div>
      <div class="channel-item text-white px-2 py-1 rounded cursor-pointer hover:bg-[#37393F] flex items-center" data-channel="General Voice">
        <i class="fas fa-microphone mr-1"></i>
        General Voice
      </div>
    </div>
    
    <div class="user-panel h-14 flex items-center px-2">
      <div id="userAvatar" class="w-8 h-8 bg-blue-500 rounded-full mr-2"></div>
      <div id="username" class="flex-1 text-white text-sm font-medium">Loading...</div>
      <i id="auditLogBtn" class="fas fa-history text-gray-400 hover:text-white cursor-pointer mr-2"></i>
      <i class="fas fa-cog text-gray-400 hover:text-white cursor-pointer"></i>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col">
    <!-- Chat Header -->
    <div class="h-12 bg-[#2B2D31] flex items-center px-4 text-white border-b border-[#202225]">
      <i class="fas fa-hashtag mr-1"></i>
      <span id="channelName" class="font-medium"># general</span>
    </div>
    
    <!-- Messages -->
    <div id="messages" class="flex-1 overflow-y-auto scroller p-4 space-y-4">
      <div class="text-center text-gray-500 text-xs py-4">This is the start of the chat</div>
    </div>
    
    <!-- Message Input -->
    <div class="p-4">
      <div class="message-input rounded-lg px-4 py-2 flex items-center">
        <i class="fas fa-plus text-gray-400 mr-3 cursor-pointer hover:text-white"></i>
        <input id="messageInput" type="text" placeholder="Message #general" class="flex-1 bg-transparent text-white outline-none"/>
        <i class="fas fa-paperclip text-gray-400 mr-3 cursor-pointer hover:text-white"></i>
        <i class="fas fa-microphone text-gray-400 cursor-pointer hover:text-white"></i>
      </div>
    </div>
  </div>

  <!-- Audit Log Modal -->
  <div id="auditModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 class="text-xl font-bold text-white mb-4">Audit Log</h2>
      <div id="auditLogContent" class="space-y-3">
        <div class="text-gray-500">Loading audit logs...</div>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    const pathParts = location.pathname.split('/');
    const serverId = pathParts[2];
    const channelId = pathParts[4];

    let peerId, userId;
    const token = localStorage.getItem('token');
    const tempUsername = localStorage.getItem('tempUsername');
    
    if (token) {
      socket.emit('auth', { token });
    } else if (tempUsername) {
      socket.emit('auth', { tempUsername });
      peerId = tempUsername;
      document.getElementById('username').textContent = tempUsername;
      document.getElementById('userAvatar').style.backgroundColor = '#4752c4';
    } else {
      window.location.href = '/';
    }

    let key, replyTo = null;
    let pendingAttachments = [];
    const messageCache = new Map();

    // Set server/channel names
    document.getElementById('serverName').textContent = serverId;
    document.getElementById('channelName').textContent = `# ${channelId}`;

    // Wait for auth
    if (!token) {
      initializeChat();
    }

    function initializeChat() {
      // Simple encryption key (in real app, use proper key derivation)
      key = serverId + channelId + (userId || 'temp');
      socket.emit('join', { channel: serverId + channelId });
    }

    // Message sending
    document.getElementById('messageInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text) return;

      // Add to UI immediately
      addMessage(text, true, peerId, Date.now().toString(), null, []);
      
      // Send to server
      socket.emit('m', {
        c: text,
        i: '',
        rep: replyTo,
        attachments: pendingAttachments
      });

      input.value = '';
      pendingAttachments = [];
      replyTo = null;
    }

    // === SOCKET HANDLERS ===
    socket.on('h', h => {
      const container = document.getElementById('messages');
      container.innerHTML = '<div class="text-center text-gray-500 text-xs py-4">This is the start of the chat</div>';
      
      h.forEach(msg => {
        addMessage(msg.c, msg.s === peerId, msg.s, msg._id, msg.rep, msg.attachments || []);
      });
    });

    socket.on('m', msg => {
      if (msg.s === peerId) return;
      addMessage(msg.c, false, msg.s, msg._id, msg.rep, msg.attachments || []);
    });

    socket.on('o', n => {
      // Update online count if needed
    });

    socket.on('t', ({ s, t }) => {
      // Typing indicator if needed
    });

    socket.on('lm', lm => {
      // Last message if needed
    });

    // === MESSAGE RENDERING ===
    function addMessage(text, isMe, sender, msgId, replyText, attachments) {
      const container = document.getElementById('messages');
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex ${isMe ? 'justify-end' : ''} mb-4`;
      
      if (!isMe) {
        messageDiv.innerHTML = `
          <div class="w-10 h-10 bg-blue-500 rounded-full mr-3 flex-shrink-0"></div>
          <div class="flex-1 max-w-[80%]">
            <div class="text-gray-100 font-medium text-sm">${sender}</div>
            <div class="text-gray-300 text-sm">${text}</div>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="flex-1 max-w-[80%] text-right">
            <div class="text-gray-300 text-sm">${text}</div>
            <div class="text-gray-500 text-xs mt-1">Just now</div>
          </div>
          <div class="w-10 h-10 bg-green-500 rounded-full ml-3 flex-shrink-0"></div>
        `;
      }
      
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    // === INPUT HANDLERS ===
    document.querySelector('.fa-paperclip').addEventListener('click', () => {
      alert('File upload would open here');
    });

    document.querySelector('.fa-microphone').addEventListener('click', () => {
      alert('Voice call would start here');
    });

    // Channel switching
    document.querySelectorAll('.channel-item').forEach(item => {
      item.addEventListener('click', () => {
        const channel = item.getAttribute('data-channel');
        window.location.href = `/server/${serverId}/channel/${channel}`;
      });
    });

    // Audit Log Modal
    document.getElementById('auditLogBtn').addEventListener('click', async () => {
      const modal = document.getElementById('auditModal');
      const content = document.getElementById('auditLogContent');
      content.innerHTML = '<div class="text-gray-500">Loading audit logs...</div>';
      modal.style.display = 'block';
      
      try {
        const res = await fetch(`/api/server/${serverId}/audit-logs`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        if (res.ok) {
          const logs = await res.json();
          if (logs.length === 0) {
            content.innerHTML = '<div class="text-gray-500">No audit logs found</div>';
          } else {
            content.innerHTML = logs.map(log => {
              const actionMap = {
                'MEMBER_JOIN': { icon: 'action-join', text: 'joined the server' },
                'MEMBER_LEAVE': { icon: 'action-leave', text: 'left the server' },
                'CHANNEL_CREATE': { icon: 'action-create', text: 'created channel' },
                'MESSAGE_DELETE': { icon: 'action-kick', text: 'deleted a message' },
                'BAN': { icon: 'action-ban', text: 'banned member' },
                'KICK': { icon: 'action-kick', text: 'kicked member' },
                'TIMEOUT': { icon: 'action-timeout', text: 'timed out member' },
                'SERVER_CREATE': { icon: 'action-create', text: 'created server' }
              };
              
              const action = actionMap[log.action] || { icon: 'action-create', text: log.action };
              const date = new Date(log.createdAt).toLocaleString();
              
              return `
                <div class="flex items-start p-2 hover:bg-[#2F3136] rounded">
                  <span class="action-icon ${action.icon}">${action.text.charAt(0)}</span>
                  <div class="flex-1">
                    <div class="text-white font-medium">${log.userId}</div>
                    <div class="text-gray-300 text-sm">${action.text} ${log.targetId ? `(${log.targetId})` : ''}</div>
                    <div class="text-gray-500 text-xs mt-1">${date}</div>
                    ${log.details ? `<div class="text-gray-400 text-xs mt-1">Details: ${JSON.stringify(log.details)}</div>` : ''}
                  </div>
                </div>
              `;
            }).join('');
          }
        } else {
          content.innerHTML = '<div class="text-red-400">Failed to load audit logs</div>';
        }
      } catch (e) {
        content.innerHTML = '<div class="text-red-400">Error loading audit logs</div>';
      }
    });

    // Close modal
    document.querySelector('.close').addEventListener('click', () => {
      document.getElementById('auditModal').style.display = 'none';
    });

    window.addEventListener('click', (e) => {
      const modal = document.getElementById('auditModal');
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  </script>
</body>
</html>
