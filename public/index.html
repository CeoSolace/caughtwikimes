<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoidChat – 30-Min Vanish</title>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="icon" href="/assets/logo.png"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>
  <style>
    :root { --glass: rgba(255, 255, 255, 0.1); }
    .glass { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    .typing { font-size: 0.8rem; color: #aaa; }
    .room-link { font-family: 'Courier New', monospace; }
  </style>
</head>
<body class="h-full bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white">

<div class="min-h-screen flex flex-col">
  <!-- Header -->
  <header class="glass border-b border-white/10 p-4">
    <div class="max-w-4xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-2">
        <img src="/assets/logo.png" alt="VoidChat" class="w-8 h-8"/>
        <h1 class="text-xl font-bold">VoidChat</h1>
      </div>
      <div class="text-sm">Secure • Ephemeral • Private</div>
    </div>
  </header>

  <!-- Homepage -->
  <div id="home" class="flex-1 flex items-center justify-center p-6">
    <div class="glass rounded-2xl p-8 max-w-md w-full shadow-2xl border border-white/20 text-center">
      <h2 class="text-3xl font-bold mb-4">30-Minute Vanishing Chat</h2>
      <p class="text-sm opacity-80 mb-8">All messages auto-delete forever. No logs. No trace.</p>

      <button id="genBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-4 rounded-xl hover:scale-105 transition text-lg shadow-lg">
        Generate Secure Room
      </button>

      <div id="roomInfo" class="hidden mt-6 p-4 bg-white/5 rounded-lg border border-white/10">
        <p class="text-xs mb-2">Your unguessable room:</p>
        <p id="roomDisplay" class="room-link text-lg font-mono bg-black/20 p-2 rounded break-all"></p>
        <div class="flex gap-2 mt-3">
          <button onclick="copyLink()" class="flex-1 bg-white/10 py-2 rounded text-sm">Copy Link</button>
          <button onclick="showQR()" class="flex-1 bg-white/10 py-2 rounded text-sm">Show QR</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Room -->
  <div id="chatRoom" class="hidden flex-1 flex flex-col max-w-4xl mx-auto w-full p-4 gap-4">
    <div class="flex justify-between items-center mb-2">
      <div class="flex items-center gap-2">
        <span id="roomCode" class="font-mono bg-white/10 px-3 py-1 rounded text-sm"></span>
        <button onclick="copyLink()" class="text-xs bg-white/10 px-2 py-1 rounded">Copy</button>
        <button onclick="showQR()" class="text-xs bg-white/10 px-2 py-1 rounded">QR</button>
      </div>
      <div id="count" class="text-sm">0 online</div>
    </div>

    <div id="messages" class="flex-1 overflow-y-auto p-4 glass rounded-xl border border-white/10 space-y-3"></div>

    <div class="flex gap-2">
      <input id="msgInput" placeholder="Type a message..." class="flex-1 p-3 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:border-purple-400"/>
      <button onclick="send()" class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 rounded-lg font-bold hover:scale-105 transition">Send</button>
    </div>

    <div id="typing" class="typing h-5"></div>
  </div>
</div>

<!-- QR Modal -->
<div id="qrModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50" onclick="this.classList.add('hidden')">
  <div class="glass p-6 rounded-xl" onclick="event.stopPropagation()">
    <div id="qrcode"></div>
    <p class="text-center mt-4 text-sm">Scan to join</p>
  </div>
</div>

<script>
  // === GLOBALS ===
  const socket = io();
  let roomId, peerId = crypto.randomUUID().slice(0,8), aesKey;
  let typingTimeout;

  // === DOM READY ===
  document.addEventListener('DOMContentLoaded', () => {
    const genBtn = document.getElementById('genBtn');
    if (!genBtn) return console.error('Generate button not found');

    genBtn.addEventListener('click', generateRoom);
    genBtn.disabled = false;
  });

  // === GENERATE ROOM ===
  async function generateRoom() {
    const btn = document.getElementById('genBtn');
    btn.disabled = true;
    btn.textContent = 'Generating...';

    try {
      // 256-bit random room ID
      const bytes = crypto.getRandomValues(new Uint8Array(32));
      roomId = Array.from(bytes)
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');

      // Derive AES key from roomId
      const base = await crypto.subtle.importKey(
        'raw',
        new TextEncoder().encode(roomId),
        'PBKDF2',
        false,
        ['deriveKey']
      );
      aesKey = await crypto.subtle.deriveKey(
        {
          name: 'PBKDF2',
          salt: new TextEncoder().encode('voidchat-entropy'),
          iterations: 600000,
          hash: 'SHA-256'
        },
        base,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt', 'decrypt']
      );

      enterRoom();
    } catch (err) {
      console.error('Crypto failed:', err);
      alert('Web Crypto not supported. Use modern browser.');
      btn.disabled = false;
      btn.textContent = 'Generate Secure Room';
    }
  }

  function enterRoom() {
    socket.emit('join', { room: roomId, peer: peerId });

    // UI: Show chat + room info
    document.getElementById('home').classList.add('hidden');
    document.getElementById('chatRoom').classList.remove('hidden');
    document.getElementById('roomCode').textContent = roomId;
    document.getElementById('roomDisplay').textContent = roomId;
    document.getElementById('roomInfo').classList.remove('hidden');

    // Auto-copy invite link
    const url = `${location.origin}?room=${roomId}`;
    navigator.clipboard.writeText(url).catch(() => {});
    setTimeout(() => alert('Link copied to clipboard!'), 300);
  }

  // === SOCKET EVENTS ===
  socket.on('history', async msgs => {
    const chat = document.getElementById('messages');
    chat.innerHTML = '';
    for (const m of msgs) {
      const text = await decrypt(m.ciphertext, m.iv);
      addMessage(text, m.isMe, m.sender);
    }
  });

  socket.on('message', async msg => {
    const text = await decrypt(msg.ciphertext, msg.iv);
    addMessage(text, false, msg.sender);
  });

  socket.on('online-count', n => {
    document.getElementById('count').textContent = `${n} online`;
  });

  socket.on('typing', ({ peerId: id, isTyping }) => {
    const el = document.getElementById('typing');
    el.textContent = isTyping ? `${id} is typing...` : '';
  });

  // === UI HELPERS ===
  function addMessage(text, isMe, sender) {
    const div = document.createElement('div');
    div.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
    const bubble = document.createElement('div');
    bubble.className = `max-w-xs px-4 py-2 rounded-2xl ${isMe ? 'bg-gradient-to-r from-purple-600 to-pink-600' : 'bg-white/10'}`;
    bubble.textContent = text;
    if (!isMe) {
      const name = document.createElement('div');
      name.className = 'text-xs opacity-70 mt-1';
      name.textContent = sender;
      div.appendChild(name);
    }
    div.appendChild(bubble);
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });
  }

  async function encrypt(text) {
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const data = new TextEncoder().encode(text);
    const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, aesKey, data);
    return {
      ciphertext: btoa(String.fromCharCode(...new Uint8Array(ct))),
      iv: btoa(String.fromCharCode(...iv))
    };
  }

  async function decrypt(ctB64, ivB64) {
    const ct = Uint8Array.from(atob(ctB64), c => c.charCodeAt(0));
    const iv = Uint8Array.from(atob(ivB64), c => c.charCodeAt(0));
    const pt = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, aesKey, ct);
    return new TextDecoder().decode(pt);
  }

  async function send() {
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if (!text) return;
    const { ciphertext, iv } = await encrypt(text);
    socket.emit('message', { ciphertext, iv });
    addMessage(text, true, peerId);
    input.value = '';
  }

  document.getElementById('msgInput')?.addEventListener('keypress', e => {
    if (e.key === 'Enter') send();
    clearTimeout(typingTimeout);
    socket.emit('typing', true);
    typingTimeout = setTimeout(() => socket.emit('typing', false), 1000);
  });

  function copyLink() {
    const url = `${location.origin}?room=${roomId}`;
    navigator.clipboard.writeText(url);
    alert('Link copied!');
  }

  function showQR() {
    const modal = document.getElementById('qrModal');
    const qr = document.getElementById('qrcode');
    qr.innerHTML = '';
    new QRCode(qr, {
      text: `${location.origin}?room=${roomId}`,
      width: 220, height: 220,
      colorDark: "#ffffff", colorLight: "#00000000"
    });
    modal.classList.remove('hidden');
  }

  // === AUTO-JOIN FROM URL ===
  const params = new URLSearchParams(location.search);
  const urlRoom = params.get('room');
  if (urlRoom && /^[0-9a-f]{64}$/.test(urlRoom)) {
    roomId = urlRoom;
    (async () => {
      const base = await crypto.subtle.importKey('raw', new TextEncoder().encode(roomId), 'PBKDF2', false, ['deriveKey']);
      aesKey = await crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt: new TextEncoder().encode('voidchat-entropy'), iterations: 600000, hash: 'SHA-256' },
        base, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
      );
      enterRoom();
    })();
  }

  // === PWA INSTALL ===
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    const btn = document.createElement('button');
    btn.textContent = 'Install';
    btn.className = 'fixed bottom-4 right-4 bg-purple-600 text-white px-4 py-2 rounded-full shadow-lg z-50 text-sm';
    btn.onclick = () => {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(() => btn.remove());
    };
    document.body.appendChild(btn);
  });

  // === SERVICE WORKER ===
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(console.error);
  }
</script>
</body>
</html>
